name: Generate Blog Post

on:
  workflow_dispatch:
    inputs:
      topic:
        description: 'Blog post topic (e.g., "How to Write a Thesis Introduction")'
        required: true
        type: string
      keywords:
        description: 'SEO keywords (comma-separated)'
        required: false
        type: string
      style:
        description: 'Writing style'
        required: false
        default: 'informative'
        type: choice
        options:
          - informative
          - tutorial
          - comparison
          - news
          - guide

  # Generate 2 high-quality articles per day (9am and 3pm UTC)
  schedule:
    - cron: '0 9 * * *'
    - cron: '0 15 * * *'

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout thesis app repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate blog post
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          TOPIC: ${{ inputs.topic || 'Top Thesis Writing Tips for Graduate Students in 2026' }}
          KEYWORDS: ${{ inputs.keywords || 'thesis writing,thesis tips,graduate thesis,AI thesis generator' }}
          STYLE: ${{ inputs.style || 'informative' }}
        run: npm run generate-blog

      - name: Checkout thesispost repo
        uses: actions/checkout@v4
        with:
          repository: synysterkay/thesispost
          token: ${{ secrets.GH_PAT }}
          path: thesispost-repo

      - name: Copy generated posts to thesispost repo
        run: |
          # Create posts directory if it doesn't exist
          mkdir -p thesispost-repo/posts
          
          # Copy generated MDX files
          if [ -d "generated-posts" ]; then
            cp generated-posts/*.mdx thesispost-repo/posts/ 2>/dev/null || true
            
            # Merge index.json files
            if [ -f "generated-posts/index.json" ]; then
              if [ -f "thesispost-repo/posts/index.json" ]; then
                # Merge existing and new posts
                node -e "
                  const fs = require('fs');
                  const existing = JSON.parse(fs.readFileSync('thesispost-repo/posts/index.json', 'utf8'));
                  const newPosts = JSON.parse(fs.readFileSync('generated-posts/index.json', 'utf8'));
                  
                  // Merge and dedupe by slug
                  const merged = [...newPosts];
                  existing.forEach(post => {
                    if (!merged.find(p => p.slug === post.slug)) {
                      merged.push(post);
                    }
                  });
                  
                  // Sort by date descending
                  merged.sort((a, b) => new Date(b.publishedAt || b.date) - new Date(a.publishedAt || a.date));
                  
                  fs.writeFileSync('thesispost-repo/posts/index.json', JSON.stringify(merged, null, 2));
                "
              else
                cp generated-posts/index.json thesispost-repo/posts/
              fi
            fi
          fi

      - name: Commit and push to thesispost
        run: |
          cd thesispost-repo
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add .
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "blog: Add new post - ${{ inputs.topic || 'Scheduled post' }}"
            git push
          fi

      - name: Create summary
        run: |
          echo "## ðŸ“ Blog Post Generated!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Topic:** ${{ inputs.topic || 'Scheduled post' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Style:** ${{ inputs.style || 'informative' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Keywords:** ${{ inputs.keywords || 'Auto-generated' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Features" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… AI-generated with DeepSeek" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SEO-optimized title and meta" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Random Unsplash featured image" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Proper heading structure (H2, H3)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… FAQ section included" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The post has been pushed to [thesispost](https://github.com/synysterkay/thesispost) repository." >> $GITHUB_STEP_SUMMARY
