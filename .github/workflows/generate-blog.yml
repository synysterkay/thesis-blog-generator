name: Generate Blog Post

on:
  workflow_dispatch:
    inputs:
      topic:
        description: 'Blog post topic (e.g., "How to Write a Thesis Introduction")'
        required: true
        type: string
      keywords:
        description: 'SEO keywords (comma-separated)'
        required: false
        type: string
      style:
        description: 'Writing style'
        required: false
        default: 'informative'
        type: choice
        options:
          - informative
          - tutorial
          - comparison
          - news
          - guide

  # Generate 8 high-quality articles per day (every 3 hours)
  schedule:
    - cron: '0 0 * * *'   # 12am UTC
    - cron: '0 3 * * *'   # 3am UTC
    - cron: '0 6 * * *'   # 6am UTC
    - cron: '0 9 * * *'   # 9am UTC
    - cron: '0 12 * * *'  # 12pm UTC
    - cron: '0 15 * * *'  # 3pm UTC
    - cron: '0 18 * * *'  # 6pm UTC
    - cron: '0 21 * * *'  # 9pm UTC

env:
  DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
  VERCEL_DEPLOY_HOOK: ${{ secrets.VERCEL_DEPLOY_HOOK }}

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install tsx

      - name: Generate blog post
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          TOPIC: ${{ inputs.topic || '' }}
          KEYWORDS: ${{ inputs.keywords || '' }}
          STYLE: ${{ inputs.style || 'informative' }}
        run: npx tsx scripts/generate-blog.ts

      - name: Move posts to posts directory
        run: |
          mkdir -p posts
          
          # Copy generated MDX files
          if [ -d "generated-posts" ]; then
            cp generated-posts/*.mdx posts/ 2>/dev/null || true
            
            # Merge index.json files
            if [ -f "generated-posts/index.json" ]; then
              if [ -f "posts/index.json" ]; then
                # Merge existing and new posts
                node -e "
                  const fs = require('fs');
                  const existing = JSON.parse(fs.readFileSync('posts/index.json', 'utf8'));
                  const newPosts = JSON.parse(fs.readFileSync('generated-posts/index.json', 'utf8'));
                  
                  // Merge and dedupe by slug
                  const merged = [...newPosts];
                  existing.forEach(post => {
                    if (!merged.find(p => p.slug === post.slug)) {
                      merged.push(post);
                    }
                  });
                  
                  // Sort by date descending
                  merged.sort((a, b) => new Date(b.publishedAt || b.date) - new Date(a.publishedAt || a.date));
                  
                  fs.writeFileSync('posts/index.json', JSON.stringify(merged, null, 2));
                "
              else
                cp generated-posts/index.json posts/
              fi
            fi
            
            # Clean up generated-posts folder
            rm -rf generated-posts
          fi

      - name: Commit and push
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add posts/
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            TOPIC="${{ inputs.topic || 'Scheduled post' }}"
            git commit -m "blog: Add new post - ${TOPIC:0:50}"
            git push
          fi

      - name: Trigger Vercel deployment
        if: env.VERCEL_DEPLOY_HOOK != ''
        run: |
          curl -X POST "${{ secrets.VERCEL_DEPLOY_HOOK }}"
          echo "Triggered Vercel deployment"

      - name: Create summary
        run: |
          echo "## ðŸ“ Blog Post Generated!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Topic:** ${{ inputs.topic || 'Scheduled post' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Style:** ${{ inputs.style || 'informative' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Keywords:** ${{ inputs.keywords || 'Auto-generated' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Features" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… AI-generated with DeepSeek" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SEO-optimized with links to https://www.thesisgenerator.io" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Random Unsplash featured image" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… 2000-3000 words high-quality content" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… FAQ section included" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Posts stored in [thesis-blog-generator/posts](https://github.com/synysterkay/thesis-blog-generator/tree/main/posts)" >> $GITHUB_STEP_SUMMARY
